/*
-- xy.js, version -0.1 (pre-alpha)
-- Author: Matt Evans (mtdevans.com)
-- Note: It'll be on Github when it has remotely enough features to be of use to anyone else
*/
var xyjs=(function(params){this.lineOptions=["col","wl","x","o","lw",["l","label"]];params=params||{};this.paddingLeft=params.pl||50;this.paddingBottom=params.pb||30;this.paddingRight=params.pr||10;this.paddingTop=params.pt||18;this.paddingX=this.paddingLeft+this.paddingRight;this.paddingY=this.paddingTop+this.paddingBottom;this.width=params.width||(params.w||500);this.height=params.height||(params.h||300);this.id=params.id||"graph_"+Math.round(Math.random()*5);this.plotCanvas=document.createElement("canvas");this.plotCanvas.setAttribute("width",this.width);this.plotCanvas.setAttribute("height",this.height);this.plotCanvas.id=this.id;if(params.parent&&document.getElementById(params.parent)){document.getElementById(params.parent).appendChild(this.plotCanvas);}else{document.body.appendChild(this.plotCanvas);}this.plot=function(data){this.plotCanvas.width=this.plotCanvas.width;this.data=data||[{xy:[[0,-10012],[2,28],[3,18],[4,34],[5,40],[6,80],[7,80],[11,120],[13,133],[16,80],[17,80],[21,120],[23,133],[26,80],[27,80],[31,120],[33,133],[36,80],[37,80],[41,120],[43,133],[57,80],[58,120],[63,133],[76,80],[87,80]]}];if(typeof this.data!=typeof[]){this.data=[this.data];}this.pdata=[];for(var w=0;w<this.data.length;w++){this.pdata.push({});this.pdata[w].x=[];this.pdata[w].y=[];if(typeof this.data[w].x!="undefined"){this.pdata[w].x=this.data[w].x;this.pdata[w].y=this.data[w].y;}else{for(var z=0;z<this.data[w].xy.length;z++){this.pdata[w].x.push(this.data[w].xy[z][0]);this.pdata[w].y.push(this.data[w].xy[z][1]);}}this.pdata[w].len=this.pdata[w].x.length;this.pdata[w].options={};var tmp=this.data[w].options?this.data[w].options.split(","):[];for(q in this.lineOptions){var u=0;while(u<tmp.length){var tmp2=tmp[u++].split(":");if(tmp2[0]==this.lineOptions[q]){var val;if(tmp2.length==1){val=true;}else{val=tmp2[1];}this.pdata[w].options[this.lineOptions[q]]=val;}else{if((typeof this.lineOptions[q]).indexOf("ject")!=-1){for(var d in this.lineOptions[q]){if(tmp2[0]==this.lineOptions[q][d]){var val;if(tmp2.length==1){val=true;}else{val=tmp2[1];}}}this.pdata[w].options[this.lineOptions[q][d]]=val;}}}}if(typeof this.pdata[w].options.col=="undefined"){this.pdata[w].options.col=this.returnColour(w);}if(typeof this.pdata[w].options.lw=="undefined"){this.pdata[w].options.lw=2;}if(typeof this.pdata[w].options.wl=="undefined"){this.pdata[w].options.wl=true;}}var c=this.plotCanvas.getContext("2d");this.maxX=this.getMaxX();this.maxY=this.getMaxY();this.minX=this.getMinX();this.minY=this.getMinY();for(var w=0;w<this.pdata.length;w++){c.lineWidth=this.pdata[w].options.lw;c.strokeStyle=this.pdata[w].options.col;if(this.pdata[w].options.wl==true){c.beginPath();c.moveTo(this.getXPixel(this.pdata[w].x[0],w),this.getYPixel(this.pdata[w].y[0],w));for(var i=1;i<this.pdata[w].len;i++){c.lineTo(this.getXPixel(this.pdata[w].x[i],w),this.getYPixel(this.pdata[w].y[i],w));}c.stroke();}if(this.pdata[w].options.o==true){c.fillStyle=this.pdata[w].options.col;for(var i=0;i<this.pdata[w].len;i++){c.beginPath();c.arc(this.getXPixel(this.pdata[w].x[i],w),this.getYPixel(this.pdata[w].y[i],w),4,0,Math.PI*2,true);c.fill();}}}c.lineWidth=2;c.strokeStyle="#222";c.font="italic 8pt sans-serif";c.textAlign="center";c.beginPath();c.moveTo(this.paddingLeft,this.paddingTop);c.lineTo(this.paddingLeft,this.height-this.paddingBottom);c.stroke();c.moveTo(this.paddingLeft,this.height-this.paddingBottom);c.lineTo(this.width-this.paddingRight,this.height-this.paddingBottom);c.stroke();c.lineWidth=2;c.strokeStyle="#222";c.font="italic 8pt sans-serif";c.textAlign="center";var step=((this.maxX-this.minX));var magnitude=this.poweroften(this.maxX);var fc=Math.pow(10,-magnitude);var effmax=this.maxX*fc;var effmin=this.minX*fc;var delta=(effmax-effmin);var x_labels_n=delta-delta%Math.pow(10,-magnitude);while(x_labels_n<2){magnitude--;delta*=10;x_labels_n=delta-delta%Math.pow(10,-magnitude);}while(x_labels_n>30){magnitude++;delta/=10;x_labels_n=delta-delta%Math.pow(10,-magnitude);}for(var i=this.minX;i<=x_labels_n*Math.pow(10,magnitude);i+=Math.pow(10,magnitude)){c.fillText(this.sround(i,magnitude-1),this.getXPixel(i),this.height-this.paddingBottom+20);}c.textAlign="right";c.textBaseline="middle";var step=((this.maxY-this.minY));var magnitude=this.poweroften(this.maxY);var fc=Math.pow(10,-magnitude);var wymax=this.maxY*fc;var wymin=this.minY*fc;var delta=(wymax-wymin);var y_labels_n=delta-delta%Math.pow(10,-magnitude);while(y_labels_n<2){magnitude--;delta*=10;y_labels_n=delta-delta%Math.pow(10,-magnitude);}while(y_labels_n>30){magnitude++;delta/=10;y_labels_n=delta-delta%Math.pow(10,-magnitude);}for(var i=this.minY;i<=y_labels_n*Math.pow(10,magnitude);i+=Math.pow(10,magnitude)){c.fillText(this.exp(this.sround(i,magnitude-1)),this.paddingLeft-10,this.getYPixel(i));}};this.exp=function(n){var m=4;n=parseFloat(n);if(Math.abs(n)>Math.pow(10,m)){while(Math.abs(n)>Math.pow(10,++m)){}n/=Math.pow(10,--m);n=Math.round(10*n)/10;return n+"e"+m;}else{if(Math.abs(n)<Math.pow(10,-m)&&n!=0){while(Math.abs(n)<Math.pow(10,-(++m))){}n/=Math.pow(10,-(m));n=Math.round(10*n)/10;return n+"e-"+m;}else{return n;}}};this.getMaxY=function(){var max=0;for(var w=0;w<this.pdata.length;w++){for(var i=0;i<this.pdata[w].len;i++){if(this.pdata[w].y[i]>max){max=this.pdata[w].y[i];}}}max+=10-max%10;return max;};this.getMinY=function(){var min=0;for(var w=0;w<this.pdata.length;w++){for(var i=0;i<this.pdata[w].len;i++){if(this.pdata[w].y[i]<min){min=this.pdata[w].y[i];}}}min-=10+min%10;return min;};this.getMaxX=function(){var max=0;for(var w=0;w<this.pdata.length;w++){for(var i=0;i<this.pdata[w].len;i++){if(this.pdata[w].x[i]>max){max=this.pdata[w].x[i];}}}return max;};this.getMinX=function(){var min=0;for(var w=0;w<this.pdata.length;w++){for(var i=0;i<this.pdata[w].len;i++){if(this.pdata[w].x[i]<min){min=this.pdata[w].x[i];}}}return min;};this.getXPixel=function(val){return((this.width-this.paddingX)*(-this.minX+val)/(this.maxX-this.minX))+this.paddingLeft;};this.getYPixel=function(val){return((this.height-this.paddingY)*(this.maxY-val)/(this.maxY-this.minY))+this.paddingTop;};this.poweroften=function(n){var pot=0;if(n>1){while(n>=Math.pow(10,++pot)){}pot--;}else{while(n<=Math.pow(10,--pot)){}pot++;}return pot;};this.sround=function(n,p){var x=Math.round(n*Math.pow(10,-p))*Math.pow(10,p);if(x<1&&x>0){var splitDecimal=(new String(x)).split(".");var xxx=splitDecimal[1].split("");x=""+splitDecimal[0]+".";for(var i=0;i<-p;i++){x+=xxx[i];}}return x;};this.returnColour=function(w){this.colours=["#ff1d1d","#088408","#2626ff","#2FCBCB","#C005C0"];this.defaultColour="#000";return w>=this.colours.length?this.defaultColour:this.colours[w];};});
